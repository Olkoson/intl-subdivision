name: PHPUnit

on:
    push:
    pull_request:

defaults:
    run:
        shell: bash

jobs:

    tests:
        name: Tests
        runs-on: Ubuntu-20.04

        env:
            extensions: amqp,apcu,igbinary,intl,mbstring,memcached

        strategy:
            matrix:
                include:
                    -   php: '7.2'
                    -   php: '8.0'
                    -   php: '7.4'
                        mode: high-deps
                    -   php: '8.0'
                        mode: low-deps
                    -   php: '8.1'
                        mode: experimental
            fail-fast: false

        steps:
            -   name: Checkout
                uses: actions/checkout@v2
                with:
                    fetch-depth: 2

            -   name: Configure for PHP 8.1
                if: "${{ matrix.php == '8.1' }}"
                run: |
                    echo "extensions=mbstring" >> $GITHUB_ENV
                    composer config platform.php 8.0.99

            -   name: Setup PHP
                uses: shivammathur/setup-php@v2
                with:
                    coverage: "none"
                    ini-values: date.timezone=America/Chicago,memory_limit=-1,default_socket_timeout=10,session.gc_probability=0,apc.enable_cli=1,zend.assertions=1
                    php-version: "${{ matrix.php }}"
                    extensions: "${{ env.extensions }}"
                    tools: flex

            -   name: Setup Composer
                uses: php-actions/composer@v5 # or alternative dependency management

            -   name: Run Tests
                uses: php-actions/phpunit@v3
                with:
                    bootstrap: vendor/autoload.php
